<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="https://jerkwin.github.io/jscss/pmd.min.css">
<script src="https://jerkwin.github.io/jscss/ChemDoodleWeb.js"></script>

<div class="wrap">

<table>

<tr><td colspan=2>
晶胞中所有原子的坐标(xyz, 单位 Å)<br/><textarea id="cell" style="width:100%; height:100px;">
34
all atoms in the cell
 Al    0.63645695    4.33559444    3.40117915
 Al    3.24255149    8.82805435    3.40117915
 Al    3.18397556    2.86092352    3.37849123
 Al    0.61632013    7.35339240    3.37849123
 Si    4.97759885    3.02108548    0.63135253
 Si    2.40994343    7.51355436    0.63135253
 Si    2.45423342    1.47865537    0.64272486
 Si   -0.11342200    5.97112426    0.64272486
 O    -0.34968872    3.10313550    2.23373068
 O     2.25640582    7.59559541    2.23373068
 O     0.03050828    5.88160895    2.24298889
 O     2.59816562    1.38914027    2.24298179
 O     5.20092501    4.49196614   -0.04907201
 O     2.63326959    8.98443503   -0.04907201
 O     1.01987812    2.05756950    0.12139239
 O     3.62597791    6.55004737    0.12139239
 O     1.05196540    6.88891011   -0.04526231
 O     3.61962082    2.39644122   -0.04526231
 O    -0.35271610    8.62960992    2.30146099
 O     2.21493933    4.13714103    2.30146099
 O     3.78723971    1.36225006    4.30183535
 O     1.21958625    5.85472814    4.30182826
 O    -0.96785824    4.10949508    4.29902597
 O     1.63823634    8.60196396    4.29902597
 O    -0.95645507    7.56425262    4.34150727
 O     1.61120553    3.07178373    4.34150727
 H     0.13707735    9.47413684    2.30862634
 H     2.70473276    4.98166795    2.30862634
 H     4.06714986    1.38934309    5.23321034
 H     1.49949443    5.88181198    5.23321034
 H    -1.18003324    4.35510829    5.21791480
 H     1.42606134    8.84757718    5.21791480
 H     1.43671795    2.68176536    5.21628308
 H    -1.13093751    7.17422526    5.21628308
</textarea><br>
晶胞参数(a b c α β γ, 单位 Å °)： <input type="box" id="box" style="width:50%" value='5.17375   8.98502   7.35224      91.68430   105.12793   89.75488'><br>
超晶胞扩展：
a方向 <input type="box" id="Na" value="20" style="width:50px;"/> &nbsp;&nbsp;&nbsp;&nbsp;
b方向 <input type="box" id="Nb" value="1" style="width:50px;"/> &nbsp;&nbsp;&nbsp;&nbsp;
c方向 <input type="box" id="Nc" value="1" style="width:50px;"/>
</td></tr>

<tr><td colspan=2>
卷曲方程(t, pi, tau=2pi, xbox, ybox, zbox)<br>

<input type="radio" name="roll" id="rollx" checked='true'>
X方向 <input type="box" id="Fx"  style="width:40%" value='10*t*cos(tau*t)'>
 切线 <input type="box" id="dFx" style="width:40%" value='cos(tau*t)-t*sin(tau*t)*tau'><br>
<input type="radio" name="roll" id="rolly">
Y方向 <input type="box" id="Fy"  style="width:40%" value='0'>
 切线 <input type="box" id="dFy" style="width:40%" value='0'><br>
<input type="radio" name="roll" id="rollz" >
Z方向 <input type="box" id="Fz"  style="width:40%" value='10*t*sin(tau*t)'>
 切线 <input type="box" id="dFz" style="width:40%" value='sin(tau*t)+t*cos(tau*t)*tau'><br><br>

扭曲方程(t, pi, tau=2pi, xbox, ybox, zbox, tbox)： <input type="box" id="vF"  style="width:40%" value=''>

<!--

X方向 <input type="box" id="Fx"  style="width:40%" value=''>
 切线 <input type="box" id="dFx" style="width:40%" value=''><br>
Z方向 <input type="box" id="Fz"  style="width:40%" value=''>
 切线 <input type="box" id="dFz" style="width:40%" value=''><br>

X方向 <input type="box" id="Fx"  style="width:40%" value='16*pow(sin(t),3)' />
 切线 <input type="box" id="dFx" style="width:40%" value='10*sin(2*pi*t)' /><br>
Z方向 <input type="box" id="Fz"  style="width:40%" value='13*cos(t)-5*cos(2*t)-2*cos(3*t)-cos(4*t)' />
 切线 <input type="box" id="dFz" style="width:40%" value='10*sin(2*pi*t)' /><br>

X方向 <input type="box" id="Fx"  style="width:40%" value='10*(cos(t)-.5*cos(2*t))' />
 切线 <input type="box" id="dFx" style="width:40%" value='10*sin(2*pi*t)' /><br>
Z方向 <input type="box" id="Fz"  style="width:40%" value='10*(sin(t)-.5*sin(2*t))' />
 切线 <input type="box" id="dFz" style="width:40%" value='10*sin(2*pi*t)' /><br>

X方向 <input type="box" id="Fx"  style="width:40%" value='10*t*sin(2*pi*t)' />
 切线 <input type="box" id="dFx" style="width:40%" value='10*sin(2*pi*t)' /><br>
Z方向 <input type="box" id="Fz"  style="width:40%" value='10*t*cos(2*pi*t)' />
 切线 <input type="box" id="dFz" style="width:40%" value='10*sin(2*pi*t)' /><br>

-->

</td></tr>

<tr><td colspan=2>
<input type="button" value="创建" onClick="genCoor()" style="font-size:1em;font-weight:bold;color:red;width:100%; height:30px" />
</td></tr>

<tr>
    <td>
        坐标文件(xyz)<br/><textarea id="groCoor" style="width:400px; height:500px; resize: none"></textarea>
    </td>
    <td>
        <figure><figurecaption>结构</figurecaption><br/>
        <script>
            ChemDoodle.default_backgroundColor = 'black';var Mol1=new ChemDoodle.TransformCanvas3D('Mol-1', 400,500);Mol1.specs.atoms_displayLabels_3D=false;Mol1.specs.compass_display=true;Mol1.specs.atoms_resolution_3D = 15;Mol1.specs.bonds_resolution_3D = 15;Mol1.specs.shapes_color = '#fff';Mol1.specs.projectionPerspective_3D = false;Mol1.specs.set3DRepresentation('Ball and Stick');Mol1.specs.crystals_unitCellLineWidth = 1.5;Mol1.handle = null;Mol1.timeout = 15;Mol1.startAnimation = ChemDoodle._AnimatorCanvas.prototype.startAnimation;Mol1.stopAnimation = ChemDoodle._AnimatorCanvas.prototype.stopAnimation;Mol1.isRunning = ChemDoodle._AnimatorCanvas.prototype.isRunning;Mol1.dblclick = ChemDoodle.RotatorCanvas.prototype.dblclick;Mol1.nextFrame = function(delta){var matrix = [];ChemDoodle.lib.mat4.identity(matrix);var change = delta*Math.PI/15000;ChemDoodle.lib.mat4.rotate(matrix, change, [ 1, 0, 0 ]);ChemDoodle.lib.mat4.rotate(matrix, change, [ 0, 1, 0 ]);ChemDoodle.lib.mat4.rotate(matrix, change, [ 0, 0, 1 ]);ChemDoodle.lib.mat4.multiply(this.rotationMatrix, matrix)};var Fcif='';var cell=ChemDoodle.readCIF(Fcif, 1,1,1);Mol1.loadContent([cell.molecule], [cell.unitCell]);Mol1.startAnimation();var $=function(id){return document.getElementById(id)};function setSupercell1(){var cell=ChemDoodle.readCIF(Fcif, $("Mol1x").value, $("Mol1y").value, $("Mol1z").value);Mol1.loadContent([cell.molecule], [cell.unitCell]);Mol1.repaint()}function setModel1(model){Mol1.specs.set3DRepresentation(model);Mol1.setupScene();Mol1.repaint()}function setProj1(yesPers){Mol1.specs.projectionPerspective_3D = yesPers;Mol1.setupScene();Mol1.repaint()}
        </script></figure>
    </td>
</tr>
<tr><td colspan="2">
视图: <input type="radio" name="group2" onclick="setProj1(true)">投影<input type="radio" name="group2" onclick="setProj1(false)" checked="">正交<br>模型: <input type="radio" name="model" onclick="setModel1(&#39;Ball and Stick&#39;)" checked="">球棍<input type="radio" name="model" onclick="setModel1(&#39;van der Waals Spheres&#39;)">范德华球<input type="radio" name="model" onclick="setModel1(&#39;Stick&#39;)">棍状<input type="radio" name="model" onclick="setModel1(&#39;Wireframe&#39;)">线框<input type="radio" name="model" onclick="setModel1(&#39;Line&#39;)">线型&nbsp;&nbsp; <input type='checkbox' onclick='Mol1.specs.atoms_displayLabels_3D=this.checked;Mol1.repaint()'>名称<br>超晶胞: X <input type="text" style="width:20px;" id="Mol1x" value="1">&nbsp;&nbsp;Y <input type="text" style="width:20px;" id="Mol1y" value="1">&nbsp;&nbsp;Z <input type="text" style="width:20px;" id="Mol1z" value="1">&nbsp;&nbsp;<input type="button" value="创建" onclick="setSupercell1()"><br>左键: 转动&nbsp;&nbsp; 滚轮: 缩放&nbsp;&nbsp; 双击: 开关自动旋转&nbsp;&nbsp; Alt+左键: 移动
</td></tr>
</table>
</div>

<script>
var d2r=Math.atan2(1,1)/45, r2d=1/d2r
var $=function(id){return document.getElementById(id)};
function trim(s){return s.replace(/^(\s|\u00A0)+/,'').replace(/(\s|\u00A0)+$/,'')}

var Xbox, Ybox, Zbox, Ft, dFt, vFt, isFt=false, isdFt=false,
	RotMat=[[0,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1]]

function mathFunction(str) {
	var fun="pow sqrt exp log abs ceil floor min max round random sin cos tan asin acos atan atan2 toSource valueOf"
	fun=fun.split(/\s+/)
	for(var i=0, n=fun.length; i<n; i++)
		str=str.replace(new RegExp(fun[i]+'\\(','g'), 'Math.'+fun[i]+'(')

	str=str.replace(/pi/ig, '(Math.PI)').replace(/tau/ig, '(2*Math.PI)')
	str=str.replace(/xbox/ig, printf('(%.6f)',Xbox)).replace(/ybox/ig, printf('(%.6f)',Ybox)).replace(/zbox/ig, printf('(%.6f)',Zbox))
	return str
}

function genCoor() {

	if(trim($('Fx').value).length>0
	&& trim($('Fy').value).length>0
	&& trim($('Fz').value).length>0) isFt=true

	if(isFt
	&& trim($('dFx').value).length>0
	&& trim($('dFy').value).length>0
	&& trim($('dFz').value).length>0) isdFt=true

	var i, j, k, ii

	var arr=[], S=[], X=[], Y=[], Z=[],
		txt=trim($('cell').value).split(/\r*\n/), Ncif=parseInt(txt[0])

	for(i=1; i<=Ncif; i++) {
		arr=trim(txt[i+1]).split(/\s+/)
		S[i]=arr[0]
		X[i]=parseFloat(arr[1])
		Y[i]=parseFloat(arr[2])
		Z[i]=parseFloat(arr[3])
	}

	arr=trim($('box').value).split(/\s+/)
	var a = parseFloat(arr[0]), b = parseFloat(arr[1]), c = parseFloat(arr[2]),
		alpha = parseFloat(arr[3])*d2r,
		beta = parseFloat(arr[4])*d2r,
		gamma = parseFloat(arr[5])*d2r,
		Na=parseInt($('Na').value),
		Nb=parseInt($('Nb').value),
		Nc=parseInt($('Nc').value)

	var ax = a,                 ay = 0.,               az = 0.,
		bx = b*Math.cos(gamma), by = b*Math.sin(gamma), bz = 0.,
		cx = c*Math.cos(beta),
		cy = c*( Math.cos(alpha)-Math.cos(beta)*Math.cos(gamma) )/Math.sin(gamma),
		cz = Math.sqrt(c*c-cx*cx-cy*cy)

	var abc= [ [ax, bx, cx], [ay, by, cy], [az, bz, cz] ],
		uvw= invMat(abc), u, v, w,
		ux=uvw[0][0], uy=uvw[0][1], uz=uvw[0][2]
		vx=uvw[1][0], vy=uvw[1][1], vz=uvw[1][2]
		wx=uvw[2][0], wy=uvw[2][1], wz=uvw[2][2]

	var Natm=0, Satm=[], Xatm=[], Yatm=[], Zatm=[],
		Xmin=1E9, Xmax=-1E9, Ymin=Xmin, Ymax=Xmax, Zmin=Xmin, Zmax=Xmax

	for(i=0; i<Na; i++) {
		for(j=0; j<Nb; j++) {
			for(k=0; k<Nc; k++) {
				for(ii=1; ii<=Ncif; ii++) {
					Natm++
					Satm[Natm]=S[ii]

					Xatm[Natm]=X[ii] + i*ax + j*bx + k*cx
					Yatm[Natm]=Y[ii] + i*ay + j*by + k*cy
					Zatm[Natm]=Z[ii] + i*az + j*bz + k*cz

					Xmin=Math.min(Xmin, Xatm[Natm])
					Ymin=Math.min(Ymin, Yatm[Natm])
					Zmin=Math.min(Zmin, Zatm[Natm])

					Xmax=Math.max(Xmax, Xatm[Natm])
					Ymax=Math.max(Ymax, Yatm[Natm])
					Zmax=Math.max(Zmax, Zatm[Natm])
				}
			}
		}
	}

	if(Xmin<0.) { Xmax -= Xmin; for(i=1; i<=Natm; i++) Xatm[i] -= Xmin }
	if(Ymin<0.) { Ymax -= Ymin; for(i=1; i<=Natm; i++) Yatm[i] -= Ymin }
	if(Zmin<0.) { Zmax -= Zmin; for(i=1; i<=Natm; i++) Zatm[i] -= Zmin }

	Xbox=Xmax; Ybox=Ymax; Zbox=Zmax

	if(isFt) {
		Ft = new Function('t', 'r',
		 'r[0]='+mathFunction(trim($('Fx').value))+';'
		+'r[1]='+mathFunction(trim($('Fy').value))+';'
		+'r[2]='+mathFunction(trim($('Fz').value))+';')

		var XYZmax
		if($('rollx').checked) XYZmax=Xmax
		if($('rolly').checked) XYZmax=Ymax
		if($('rollz').checked) XYZmax=Zmax

		var eps=1E-3, tbox, s=0, r=[], V=[]
		for(tbox=0; s<=XYZmax; tbox+=.5) s += sarc(tbox, tbox+0.5, eps)
		tbox=tarc(XYZmax, 0, 0, tbox, eps)

		if(isdFt) {
			dFt = new Function('t', 'r',
			 'r[0]='+mathFunction(trim($('dFx').value))+';'
			+'r[1]='+mathFunction(trim($('dFy').value))+';'
			+'r[2]='+mathFunction(trim($('dFz').value))+';')

			//vFt = new Function('t', 'tht',
			//	'return 0') //+mathFunction(trim($('vF').value)).replace('tbox', tbox) )
		}

		var rollid=2
		if($('rollx').checked && trim($('Fy').value)=='0') rollid=2
		if($('rollx').checked && trim($('Fz').value)=='0') rollid=1
		if($('rolly').checked && trim($('Fx').value)=='0') rollid=12
		if($('rolly').checked && trim($('Fz').value)=='0') rollid=10
		if($('rollz').checked && trim($('Fx').value)=='0') rollid=21
		if($('rollz').checked && trim($('Fy').value)=='0') rollid=20

		var rsq, tmp, xtmp, ytmp, ztmp
		for(i=1; i<=Natm; i++) {

			Xtmp=Xatm[i]
			Ytmp=Yatm[i]
			Ztmp=Zatm[i]

			if(rollid<10) tmp=Xtmp
			else if(rollid<20) tmp=Ytmp
			else tmp=Ztmp
			t=tarc(tmp, 0, 0, tbox, eps)
			Ft(t, r)

			Xatm[i]=r[0]
			Yatm[i]=r[1]
			Zatm[i]=r[2]

			dFt(t, r)
			rsq=r[0]*r[0]+r[1]*r[1]+r[2]*r[2]
			if(rsq>0) {rsq=1./Math.sqrt(rsq); r[0]*=rsq;  r[1]*=rsq; r[2]*=rsq; }

				  if(rollid== 1) { Xatm[i] += Ytmp*(-r[1]); Yatm[i] += Ytmp*r[0]; Zatm[i]=Ztmp }
			else if(rollid== 2) { Xatm[i] += Ztmp*(-r[2]); Zatm[i] += Ztmp*r[0]; Yatm[i]=Ytmp } 
			else if(rollid==10) { Yatm[i] += Xtmp*(-r[0]); Xatm[i] += Xtmp*r[1]; Zatm[i]=Ztmp } 
			else if(rollid==12) { Yatm[i] += Ztmp*(-r[2]); Zatm[i] += Ztmp*r[1]; Xatm[i]=Xtmp } 
			else if(rollid==21) { Zatm[i] += Ytmp*(-r[1]); Yatm[i] += Ytmp*r[2]; Xatm[i]=Xtmp } 
			else if(rollid==20) { Zatm[i] += Xtmp*(-r[0]); Xatm[i] += Xtmp*r[2]; Yatm[i]=Ytmp } 

		}
	}

	var Fmol=printf('%f\nabc: %.6f %.6f %.6f %.6f %.6f %.6f %.6f %.6f %.6f\n', Natm, ax, ay, az, bx, by, bz, cx, cy, cz)
		Fcif='data_MOL\n'+Natm+'\n_symmetry_space_group_name_\' \''
		+'\n_cell_length_a '+Na*a+'\n_cell_length_b '+Nb*b+'\n_cell_length_c '+Nc*c
		+'\n_cell_angle_alpha '+alpha*r2d+'\n_cell_angle_beta '+beta*r2d+'\n_cell_angle_gamma '+gamma*r2d
		+'\nloop_\n_atom_site_label\n_atom_site_type_symbol\n_atom_site_fract_x\n_atom_site_fract_y\n_atom_site_fract_z\n'

	for(i=1; i<=Natm; i++) {
		u=ux*Xatm[i]+uy*Yatm[i]+uz*Zatm[i]
		v=vx*Xatm[i]+vy*Yatm[i]+vz*Zatm[i]
		w=wx*Xatm[i]+wy*Yatm[i]+wz*Zatm[i]
		Fcif += printf('MOL %s %8.3f %8.3f %8.3f\n', Satm[i], u/Na, v/Nb, w/Nc)
		Fmol += printf('    %3s %12.6f %12.6f %12.6f\n', Satm[i], Xatm[i], Yatm[i], Zatm[i])
	}

	$("groCoor").value=Fmol
	cell=ChemDoodle.readCIF(Fcif, 1,1,1);

	for (i=0; i<cell.molecule.atoms.length-1; i++) cell.molecule.atoms[i].altLabel = i+1;

	Mol1.loadContent([cell.molecule], [cell.unitCell])
	Mol1.startAnimation();
}

function sarc(t1, t2, eps) {
	var i, t, dt, r0=[], r1=[], Lpre=0, Lnxt=0, ds=1E99, N=2
	while(ds>eps) {
		Lpre=Lnxt; Lnxt=0
		N *= 2; dt=(t2-t1)/N
		for(i=0; i<N; i++) {
			t=t1+i*dt
			Ft(t, r0)
			Ft(t+dt, r1)
			r1[0] -= r0[0]
			r1[1] -= r0[1]
			r1[2] -= r0[2]
			Lnxt += Math.sqrt( r1[0]*r1[0]+r1[1]*r1[1]+r1[2]*r1[2] )
		}
		ds=Lnxt-Lpre
	}
	return Lnxt
}

function tarc(st, t0, t1, t2, eps) {
	var t, s, ds

	ds  = sarc(t1, t2, eps)
	st -= sarc(t0, t1, eps)

	t=t1+st*(t2-t1)/ds
	s=sarc(t1, t, eps)
	while(Math.abs(st-s)>eps) {
		if(s<st) { t1=t; st -= s; ds -= s }
		else     { t2=t;          ds =  s }

		t=t1+st*(t2-t1)/ds
		s=sarc(t1, t, eps)
	}
	return t
}

function dot(A, B) { return A[1]*B[1]+A[2]*B[2]+A[3]*B[3] }
function cross(A, B, AxB) {
	AxB[1] = A[2]*B[3]-A[3]*B[2]
	AxB[2] = A[3]*B[1]-A[1]*B[3]
	AxB[3] = A[1]*B[2]-A[2]*B[1]
}

function invMat(A) {
	var base=0, _1=base, _2=_1+1, _3=_2+1, invA,
		detA = A[_1][_1]*(A[_2][_2]*A[_3][_3]-A[_2][_3]*A[_3][_2])
			  -A[_1][_2]*(A[_2][_1]*A[_3][_3]-A[_2][_3]*A[_3][_1])
			  +A[_1][_3]*(A[_2][_1]*A[_3][_2]-A[_2][_2]*A[_3][_1])

	if(detA!=0) detA=1./detA
	if(base==0) invA = [ [0,0,0],   [0,0,0],   [0,0,0] ]
	if(base==1) invA = [ [0,0,0,0], [0,0,0,0], [0,0,0,0], [0,0,0,0] ]

	invA[_1][_1] = (  A[_2][_2]*A[_3][_3]-A[_2][_3]*A[_3][_2]  )*detA
	invA[_2][_1] = (-(A[_2][_1]*A[_3][_3]-A[_2][_3]*A[_3][_1]) )*detA
	invA[_3][_1] = (  A[_2][_1]*A[_3][_2]-A[_2][_2]*A[_3][_1]  )*detA
	invA[_1][_2] = (-(A[_1][_2]*A[_3][_3]-A[_1][_3]*A[_3][_2]) )*detA
	invA[_2][_2] = (  A[_1][_1]*A[_3][_3]-A[_1][_3]*A[_3][_1]  )*detA
	invA[_3][_2] = (-(A[_1][_1]*A[_3][_2]-A[_1][_2]*A[_3][_1]) )*detA
	invA[_1][_3] = (  A[_1][_2]*A[_2][_3]-A[_1][_3]*A[_2][_2]  )*detA
	invA[_2][_3] = (-(A[_1][_1]*A[_2][_3]-A[_1][_3]*A[_2][_1]) )*detA
	invA[_3][_3] = (  A[_1][_1]*A[_2][_2]-A[_1][_2]*A[_2][_1]  )*detA
	return invA
}

function ang(xi,yi,zi, xj,yj,zj, xk,yk,zk, nijk) {
	var Vi=[], Vk=[]
	Vi[1] = xi-xj; Vk[1] = xk-xj
	Vi[2] = yi-yj; Vk[2] = yk-yj
	Vi[3] = zi-zj; Vk[3] = zk-zj
	cross(Vi, Vk, nijk)
	var r=nijk[1]*nijk[1]+nijk[2]*nijk[2]+nijk[3]*nijk[3]
	if(r>0 && r!=1) { r=1/Math.sqrt(r); nijk[1]*=r; nijk[2]*=r; nijk[3]*=r }
	return Math.acos(dot(Vi, Vk)/Math.sqrt(dot(Vi, Vi)*dot(Vk, Vk)))*r2d
}

function RotVect(RotMat, V, x0, y0, z0) {
	var Vx = V[1]-x0, Vy = V[2]-y0, Vz = V[3]-z0
	V[1]= RotMat[1][1]*Vx + RotMat[1][2]*Vy + RotMat[1][3]*Vz + x0
	V[2]= RotMat[2][1]*Vx + RotMat[2][2]*Vy + RotMat[2][3]*Vz + y0
	V[3]= RotMat[3][1]*Vx + RotMat[3][2]*Vy + RotMat[3][3]*Vz + z0
}

function AxiRotMat(tht, x, y, z) {
	var r=x*x+y*y+z*z; if(r>0 && r!=1) { r=1/Math.sqrt(r); x*=r; y*=r; z*=r }

	tht *= d2r
	r=Math.sin(tht/2); w=Math.cos(tht/2); x*=r; y*=r; z*=r
	RotMat[1][1]= 1-2*(y*y+z*z); RotMat[1][2]=   2*(x*y-w*z); RotMat[1][3]=   2*(x*z+w*y);
	RotMat[2][1]=   2*(x*y+w*z); RotMat[2][2]= 1-2*(x*x+z*z); RotMat[2][3]=   2*(y*z-w*x);
	RotMat[3][1]=   2*(x*z-w*y); RotMat[3][2]=   2*(y*z+w*x); RotMat[3][3]= 1-2*(x*x+y*y);
}

function printf(){
    var map = {
        s: function(str, fmt) { fmt*=1;
            m=Array(Math.max(Math.abs(fmt)-str.length+1,0)).join(' ');
            return fmt>0 ? m+str : str+m},
        f: function(str, fmt) { fmt=fmt.split('.'); str=parseFloat(str).toFixed(fmt[1]);
            m=Array(Math.max(Math.abs(fmt[0])-str.length+1, 0)).join(' ')
            return fmt[0]>0 ? m+str : str+m
        }
    }
    var args = Array.prototype.slice.call(arguments).slice();
    return args.shift().toString().replace(/%(-*\d*\.*\d*)([sf])/g, function(_, fmt, type){
        if(!args.length) throw new Error('Too few elements')
        return map[type](args.shift(), fmt);
    });
}

function pbcCart(x, box) {
         if(x> 0.5*box) x -= box
    else if(x<-0.5*box) x += box
    return x
}

</script>